tinymce.PluginManager.add("bertedu_santence", function(a, b) {
	a.addButton("bertedu_santence", {
		text : "編輯句型",
		icon : !1,
		onclick : function() {

			var debug = false;
						
			var chinese = "";
			var voice = "";
			
			var loop = 100;
			var node = a.selection.getNode();
			do{
				if(node.nodeName == "TRANSLATE" || node.nodeName == "BDI" || node.nodeName == "BODY"){
					break;
				}
				node = node.parentElement;
			}while(loop-- > 0);
			
			if(node.nodeName == "TRANSLATE"){
				chinese = node.getAttribute("chinese");
				voice = node.getAttribute("voice"); 
			}
			if(node.nodeName == "BDI"){
				chinese = node.getAttribute("chinese");
				voice = node.getAttribute("voice"); 
			}
			
			a.windowManager.open({
				title : "編輯句型",
				body : [ {
                    type   : 'textbox',
                    name   : 'chinese',
                    label  : '中文翻譯',
                    value  : chinese
                },
                {
                    type   : 'filepicker',
                    name   : 'voice',
                    label  : '選擇音效',
                    value  : voice
                }],
				onsubmit : function(b) {
					
					// 選擇的文字
					var selection = a.selection.getContent();
					if(debug){console.log("選擇的文字：" + selection);}
					
					// 所屬元素
					var in_node = node.nodeName;
					if(debug){console.log("所屬元素：" + in_node);}
					if(in_node == "BDI" || in_node == "TRANSLATE"){
					
						// 如果都沒輸入值，代表刪除翻譯標籤
						if(b.data.chinese == "" && b.data.voice == ""){
							if(debug){console.log("所屬元素的內容：" + node.innerHTML);}
							node.outerHTML = node.innerHTML;
						}
						else{
							node.setAttribute("chinese",b.data.chinese);
							node.setAttribute("voice",b.data.voice);
							var content = a.getContent();
							content = content.replace(/<translate/g,"<bdi");
							content = content.replace(/<\/translate/g,"</bdi");
							a.setContent(content);
						}
					
						return;
					}
					
					
					// 從被選取的文字中除去翻譯標籤
					pure_selection = selection.replace(/<translate .*?>|<\/translate>|<bdi .*?>|<\/bdi>/g,"");
					if(debug){console.log("從被選取的文字中除去翻譯標籤：" + pure_selection);}
					
					a.selection.setContent("<bdi chinese=\"" + b.data.chinese + "\" voice=\"" + b.data.voice + "\" id=\"" + Math.uuid(8,16) + "\">" + pure_selection + "</bdi>");
					
					var content = a.getContent();
					if(debug){console.log("所有內容：" + content);}
					
					pure_content = content.replace(/<[^(img)][^\/>][^>]*><\/[^>]+>/,"");
					if(debug){console.log("過濾無用翻譯標籤的所有內容：" + pure_content);}
					a.setContent(pure_content);
					
					return;
					// <bdi>{{ 11 <a>22</a> 33 }}</bdi>
					// <bdi> 11 {{<a>22</a>}} 33 </bdi>
					// {{00 <bdi> 11 <a>22</a> 33 </bdi> 44}}
					
					//console.log(a.selection.getStart());
					var select_text = a.selection.getContent()
					outerHTML = node.outerHTML.replace(/ ?data-mce-style=".*?"/g,"");
					outerHTML = outerHTML.replace(/<br>/gi,"<br />");
					outerHTML = outerHTML.replace(/…/gi,"&hellip;");
					
					innerHTML = node.innerHTML.replace(/ ?data-mce-style=".*?"/g,"");
					innerHTML = innerHTML.replace(/<br>/gi,"<br />");
					innerHTML = innerHTML.replace(/…/gi,"&hellip;");
					
					//console.log("===================================5");
					//console.log("Content=" + a.selection.getContent());
					//console.log("NodeName=" + a.selection.getNode().nodeName);
					//console.log("REG=" + selection_text);
					//console.log("node_inner=" + innerHTML);
					//console.log("node_outer=" + outerHTML);
					//console.log("select_text=" + select_text);
					
					if(select_text==innerHTML){
						console.log("select_text==node.innerHTML");
						if(a.selection.getNode().nodeName == "TRANSLATE" || a.selection.getNode().nodeName == "BDI"){
							node.outerHTML = "<bdi chinese=\"" + b.data.chinese + "\" voice=\"" + b.data.voice + "\" id=\"" + Math.uuid(8,16) + "\">" + selection_text + "</bdi>";
						}
						else{
							node.innerHTML = "<bdi chinese=\"" + b.data.chinese + "\" voice=\"" + b.data.voice + "\" id=\"" + Math.uuid(8,16) + "\">" + selection_text + "</bdi>";
						}
						
					}
					else{
						if(innerHTML == ""){
							console.log("node.innerHTML == \"\"");
							a.selection.setContent("<bdi chinese=\"" + b.data.chinese + "\" voice=\"" + b.data.voice + "\" id=\"" + Math.uuid(8,16) + "\">" + selection_text + "</bdi>");
						}
						else{
							//console.log(outerHTML.getNode().nodeName);
							var outerHTML = outerHTML.replace(/<translate .*?>|<\/translate>/g,"");
							outerHTML = outerHTML.replace(/<bdi .*?>|<\/bdi>/g,"");
							if(selection_text == ""){
								console.log("selection_text == \"\"");
								node.outerHTML = outerHTML.replace(select_text,"");
							}
							else{
								console.log("else");
								node.outerHTML = outerHTML.replace(select_text,"<bdi chinese=\"" + b.data.chinese + "\" voice=\"" + b.data.voice + "\" id=\"" + Math.uuid(8,16) + "\">" + selection_text + "</bdi>");
							}
							
						}
					}
				}
			})
		}
	}), a.addMenuItem("bertedu_santence", {
		text : "編輯句型",
		context : "tools",
		onclick : function() {
			a.windowManager.open({
				title : "TinyMCE site",
				url : b + "/dialog.html",
				width : 600,
				height : 400,
				buttons : [{
					text : "Insert",
					onclick : function() {
						var b = a.windowManager.getWindows()[0];
						a.insertContent(b.getContentWindow().document.getElementById("content").value), b.close()
					}
				}, {
					text : "Close",
					onclick : "close"
				}]
			})
		}
	})
}); 